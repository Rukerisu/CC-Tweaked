-- Vyhľadanie monitora a BigReactors Energizer
local monitor, cell

for _, name in ipairs(peripheral.getNames()) do
    local pType = peripheral.getType(name)
    if pType == "monitor" then
        monitor = peripheral.wrap(name)
    elseif pType and pType:lower():find("bigreactors%-energizer") then
        cell = peripheral.wrap(name)
    end
end

-- Kontrola pripojenia
if not monitor then error("Monitor not found") end
if not cell then error("BigReactors Energizer not found") end

-- Nastavenie monitora
monitor.setTextScale(1)
local w, h = monitor.getSize()

-- Pomocné funkcie
local function formatRF(value)
    if value >= 1e6 then
        return string.format("%.1fM RF", value / 1e6)
    elseif value >= 1e3 then
        return string.format("%.1fk RF", value / 1e3)
    else
        return string.format("%d RF", value)
    end
end

local function drawBar(percent)
    local barWidth = w - 4
    local fill = math.floor(barWidth * percent + 0.5)

    monitor.setCursorPos(2, 4)
    monitor.write("[")
    for i = 1, barWidth do
        if i <= fill then
            monitor.blit(" ", "0", "a")  -- zelená
        else
            monitor.blit(" ", "0", "f")  -- sivá
        end
    end
    monitor.write("]")
end

local function drawScreen()
    monitor.clear()
    monitor.setCursorPos(2, 1)
    monitor.write("BigReactors Energizer")

    local energy = cell.getEnergyStored()
    local maxEnergy = cell.getMaxEnergyStored()
    local inputRate = cell.getEnergyReceivedLastTick and cell.getEnergyReceivedLastTick() or 0
    local outputRate = cell.getEnergyExtractedLastTick and cell.getEnergyExtractedLastTick() or 0
    local enabled = cell.getActive and cell.getActive() or false

    monitor.setCursorPos(2, 3)
    monitor.write(string.format("Stored: %s / %s", formatRF(energy), formatRF(maxEnergy)))

    drawBar(energy / maxEnergy)

    monitor.setCursorPos(2, 6)
    monitor.write("Input : " .. formatRF(inputRate))

    monitor.setCursorPos(2, 7)
    monitor.write("Output: " .. formatRF(outputRate))

    monitor.setCursorPos(2, 9)
    if enabled then
        monitor.setBackgroundColor(colors.red)
        monitor.setTextColor(colors.white)
        monitor.write("[ Disable Energizer ]")
    else
        monitor.setBackgroundColor(colors.lime)
        monitor.setTextColor(colors.black)
        monitor.write("[ Enable Energizer  ]")
    end
    monitor.setBackgroundColor(colors.black)
    monitor.setTextColor(colors.white)
end

local function isInButton(x, y)
    return y == 9 and x >= 2 and x <= 23
end

-- Hlavný cyklus
while true do
    drawScreen()
    local event, side, x, y = os.pullEvent()
    if event == "monitor_touch" then
        if isInButton(x, y) then
            local current = cell.getActive()
            cell.setActive(not current)
        end
    end
    sleep(1)
end
